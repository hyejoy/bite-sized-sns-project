# 캐시데이터 다루기

- 이전 데이터에 추가하거나 수정했을 때 변경 된 데이터를 화면에 즉시 반영하기 위해
  캐시데이터를 수정해서 변경된 데이터를 화면에 즉시 반영하는 기능을 살펴봄

## 캐시 무효화 기능

- useQuery 로 생성했었던 키값을 갖는 캐시데이터를 (todos 캐시데이터) 무효화 시키면,
  useQuery hook이 데이터가 무효화 됐다는거 감지해서 자동으로 리패칭됨
- 따라서, 화면에도 새로운 todos데이터가 불러와짐

```tsx
/** src/hooks/mutations/useCreateTodoMutation.ts */

import { createTodo } from '@/api/createTodo';
import { useMutation, useQueryClient } from '@tanstack/react-query';

export function useCreateTodoMutation() {
  // 1. queryClient 불러오기 (스토어 개념으로 서버 상태와 관련된 모든 데이터들을 보관하는 저장소)
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: createTodo,
    onMutate: () => {},
    onSettled: () => {},
    onSuccess: () => {
      // createTodo 데이터 패칭이 성공적인 경우,
      // invalidateQueries 함수에 의해 인수로 설정한 todos 쿼리키로 갖는 모든 캐시 데이터가 일괄적으로 무효화됨
      queryClient.invalidateQueries({
        queryKey: ['todos'], // todos데이터 무효화
      });
    },
    onError: (error) => {
      window.alert(error.message);
    },
  });
}
```

### 발생하는 문제점

```tsx
queryClient.invalidateQueries({
  queryKey: ['todos'], // todos데이터 무효화
});
```

- invalidateQueries 메서드 호출하면서 todos 키 값을 갖는 모든 캐시데이터가 무효화가 되기때문에
  useTodoDataById (id값 기준으로 하나의 개별 todo 아이템의 데이터를 불러오고 있는 캐시데이터) 함께 무효화됨
- 불필요한 데이터까지 무효화를 시켜버리는 비효율이 발생함
- 이럴땐 쿼리키를 중복되지 않게 관리하기 위해서, 쿼리 키를 통합으로 관리하는 하나의 객체를 만들어서 사용하게 됨

### QUERY KEY FACTORY

- 구조적 키값을 이용하여 개별 관리

```ts
/** src > lib > constants.ts */
export const QUERY_KEYS = {
  todo: {
    all: ['todo'],
    list: ['todo', 'list'],
    detail: (id: string) => ['todo', 'detail', id],
  },
};

/** useTodosData.ts */
export function useTodosData() {
  return useQuery({
    queryFn: fetchTodos,
    queryKey: QUERY_KEYS.todo.list, // 👈
    // retry: 0,
  });
}

/** useTodosDataById.ts */
export function useTodoDataById(id: string) {
  return useQuery({
    queryFn: () => fetchTodoById(id),
    queryKey: QUERY_KEYS.todo.detail(id), // 👈
    staleTime: 5000,
    gcTime: 5000,
  });
}

/** useTodoMutation.ts */
import { QUERY_KEYS } from '@/lib/constants';
import { useMutation, useQueryClient } from '@tanstack/react-query';

export function useCreateTodoMutation() {
  // 1. queryClient 불러오기
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: createTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({
        queryKey: QUERY_KEYS.todo.list, // 👈
        staleTime: 5000,
      });
    },
  });
}
```

- 이렇게 하면, todo list에 캐시 데이터만 무효화하도록 설정한거기 때문에
  불필요한 데이터 리패칭이 발생하지 않음
- 이런 QUERY_KEYS를 **Query Key Factory 방식** 이라고 한다.

# 5. [TanStack Query] 낙관적 업데이트 (Optimistic Update)

## 1. 낙관적 업데이트란?

- 서버 요청이 성공할 것이라고 '낙관적으로' 가정하고, UI를 먼저 변경하는 기법입니다.
- 사용자 입장에서는 대기 시간 없이 즉각적으로 반응하는 앱처럼 느껴져 UX(사용자 경험)가 크게 향상됩니다.
- 주요 사용처: 좋아요 버튼, 체크박스 상태 변경, 간단한 텍스트 수정 등.

---

## 2. 구현 단계 및 코드 분석

### ① API 함수 작성 (`api/updateTodo.ts`)

데이터의 일부만 수정하므로 `PATCH` 메서드를 사용하고, JSON 형식을 알리기 위해 `headers`를 설정합니다.

```tsx
import { API_URL } from '@/lib/constants';
import type { Todo } from '@/types';

export async function updateTodo(todo: Partial<Todo> & { id: string }) {
  const response = await fetch(`${API_URL}/todos/${todo.id}`, {
    headers: {
      'Content-Type': 'application/json',
    },
    method: 'PATCH',
    body: JSON.stringify(todo),
  });

  if (!response.ok) throw new Error('update todo failed');
  const data: Todo = await response.json();
  return data;
}
```

### ② 커스텀 훅 작성 (hooks/mutations/useUpdateTodoMutation.ts)

- onMutate 옵션을 사용하여 실제 서버 응답이 오기 전에 캐시 데이터를 수동으로 수정합니다.

```tsx
import { updateTodo } from '@/api/updateTodo';
import { QUERY_KEYS } from '@/lib/constants';
import type { Todo } from '@/types';
import { useMutation, useQueryClient } from '@tanstack/react-query';

export function useUpdateTodoMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: updateTodo,
    // onMutate: mutate 함수가 호출될 때 실행되는 함수 (낙관적 업데이트 지점)
    onMutate: (newTodo) => {
      // 1. 기존 캐시 데이터를 직접 수정하기 위해 setQueryData 사용
      queryClient.setQueryData<Todo[]>(QUERY_KEYS.todo.list, (prevTodos) => {
        if (!prevTodos) return [];
        // 2. id가 일치하는 투두만 변경된 값으로 교체
        return prevTodos.map((prevTodo) =>
          prevTodo.id === newTodo.id ? { ...prevTodo, ...newTodo } : prevTodo
        );
      });
    },
    // (선택) 에러 발생 시 원래대로 되돌리는 로직이나 성공 후 무효화 로직을 추가할 수 있습니다.
  });
}
```

### ③ 컴포넌트 적용 (components/todo-list/TodoItem.tsx)

- 체크박스 클릭 시 mutate를 호출하면 onMutate에 의해 UI가 즉시 변경됩니다.

```tsx
import { useUpdateTodoMutation } from '@/hooks/mutations/useUpdateTodoMutation';
import type { Todo } from '@/types';

export default function TodoItem({ id, content, isDone }: Todo) {
  const { mutate } = useUpdateTodoMutation();

  const handleCheckboxClick = () => {
    // 서버 응답 전이지만 UI는 즉시 체크/해제됨
    mutate({ id, isDone: !isDone });
  };

  return (
    <div className="flex items-center justify-between border p-2">
      <div className="flex gap-5">
        <input
          type="checkbox"
          checked={isDone}
          onChange={handleCheckboxClick}
        />
        <span>{content}</span>
      </div>
    </div>
  );
}
```

## 3. 요약 및 주의사항

- onMutate 활용: mutate 호출 즉시 실행되어 캐시를 업데이트합니다.

- setQueryData: 캐시에 저장된 기존 데이터를 직접 수정할 때 사용합니다.

- 에러 처리 필수: 실제 서버에서 에러가 났을 경우를 대비해, onError에서 이전 데이터로 되돌리는(Rollback) 로직을 추가하는 것이 권장됩니다.

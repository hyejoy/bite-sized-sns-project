4.3

# tanstank Query 적용 전 코드

• 많은 로직이 필요함
• fetch 함수가 많아질수록 생성해야하는 state가 증가하는 단점
• error, loading처리를 따로 해줘야 함

```tsx
import type { Todo } from '@/types';
import { Todo } from '../types';
import { useEffect, useState } from 'react';

// 1. fetch 함수 정의
async function fetchTodos() {
  const res = await fetch(`${API_URL}/todos`);
  if (!res.ok) throw new Error('Fetch Failed');
  const data: Todo[] = await res.json();
  return data;


export default function TodoListPage() {
  // 2. 데이터 담을 state 정의
  const [todos, setTodos] = useState<Todo[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState();

  // 3. 패치데이터 실행 후 데이터 담는 로직
  const fetchData = async () => {
    setIsLoading(true);
    try {
      const data = await fetchTodos();
      setTodos(data);
    } catch (err) {
      setError(err as any);
    } finally {
      setIsLoading(false);
    }
  };

  //4. 첫 랜더링시 데이터 패치 실행
  useEffect(() => {
    fetchData();
  }, []);

  return (
    <div className="flex flex-col gap-5 p-5">
      <h1 className="text-2xl font-bold">TodoList</h1>
      <TodoEditor />
      {todos.map((item) => (
        <TodoItem key={item.id} id={item.id} content={item.content} />
      ))}
    </div>
  );
}
```

# Tanstack Query 적용하기

• import useQuery (데이터 조회 요청 관리 훅)
• use Query 훅이 자동으로 Query Function 으로 설정한 fetchTodos함수를 컴포넌트가 마운트 되었을때
자동으로 호출을 하게 됨
• 결과값을 자동으로 query key에 해당된 값으로 저장을 해줌
• 반환값은 다음과 같음

1. data : query functio인 fetchTodos반환값 제공
2. isLoading: 패치 함수 로딩 상태 제공
3. error : query function의 에러 객체를 제공
4. 그외 : is치면 여러개 뜨는데 api요청에 관련된 모든 상태값들을 자동으로 제공함

## useQuery 속성

• retry : 에러 시 재시도 횟수 설정
• 캐시에 데이터를 굉장히 오래 보관한다던지, 일정 시간을 주기로 데이터를 계속해서 다시 패칭한다던지
부가적인 기능들이 있음

```tsx
/** hooks */
import { fetchTodos } from '@/api/fetchTodos';
import { useQuery } from '@tanstack/react-query';

export function useTodosData() {
  return useQuery({
    queryKey: ['todos'],
    queryFn: fetchTodos,
  });
}

import TodoEditor from '@/components/todo-list/TodoEditor';
import TodoItem from '@/components/todo-list/TodoItem';
import { API_URL } from '@/lib/constants';
import type { Todo } from '@/types';
import { useQuery } from '@tanstack/react-query';
import { fetchTodos } from '@/api/fetchTodos';
import { useTodosData } from '@/hooks/quries/use-todos.data';

export default function TodoListPage() {
  const { data: todos, isLoading, error } = useTodosData();

  if (isLoading) return <div>로딩중 ...</div>;
  if (error) return <div>오류가 발생 했습니다</div>;
  return (
    <div className="flex flex-col gap-5 p-5">
      <h1 className="text-2xl font-bold">TodoList</h1>
      <TodoEditor />
      {todos?.map((item) => (
        <TodoItem key={item.id} id={item.id} content={item.content} />
      ))}
    </div>
  );
}
```

# 5. [TanStack Query] 낙관적 업데이트와 3가지 예외 처리

낙관적 업데이트는 UI를 즉시 반영하여 UX를 높여주지만, 네트워크 지연이나 서버 에러 발생 시 발생할 수 있는 데이터 불일치 문제를 반드시 해결해야 합니다.

## 1. 낙관적 업데이트의 3가지 핵심 예외 상황

### ① 데이터 충돌 (조회와 수정의 경합)

- **현상**: 데이터를 수정하는 중(Mutation)에 새로운 데이터를 불러오는(Query) 요청이 완료되면, 낙관적으로 업데이트해둔 캐시 데이터가 과거의 버전으로 덮어씌워질 수 있습니다.
- **해결**: `queryClient.cancelQueries`를 호출하여 진행 중인 조회 요청을 취소합니다.

### ② 요청 실패 (서버 에러 시 롤백)

- **현상**: 서버 응답을 낙관적으로 가정했으나, 실제로 서버에서 에러가 발생하면 UI와 실제 서버 데이터가 달라집니다.
- **해결**: `onMutate`에서 수정 전 데이터를 저장하여 반환하고, `onError`에서 `context`를 이용해 데이터를 원상복구합니다.

### ③ 데이터 무결성 깨짐 (예상과 다른 서버 결과)

- **현상**: 클라이언트에서는 성공을 예상하고 데이터를 수정했지만, 서버의 로직이나 버그로 인해 결과값이 클라이언트의 예상과 다르게 저장될 수 있습니다.
- **해결**: `onSettled`에서 `invalidateQueries`를 호출하여 서버로부터 최신 데이터를 다시 불러와 동기화합니다.

---

## 2. 최종 구현 코드 (`useUpdateTodoMutation.ts`)

```tsx
import { updateTodo } from '@/api/updateTodo';
import { QUERY_KEYS } from '@/lib/constants';
import type { Todo } from '@/types';
import { useMutation, useQueryClient } from '@tanstack/react-query';

export function useUpdateTodoMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: updateTodo,

    // 1. 위 위기 상황에 대비한 낙관적 업데이트 시작
    onMutate: async (updateTodo) => {
      // [예외 1 대응] 조회가 끝나는 시점과 수정이 끝나는 시점이 어긋나 데이터가 덮어씌워지는 것 방지
      await queryClient.cancelQueries({
        queryKey: QUERY_KEYS.todo.list,
      });

      // [예외 2 대응] 오류 시 원상복구할 이전 데이터를 미리 저장
      const prevTodos = queryClient.getQueryData<Todo[]>(QUERY_KEYS.todo.list);

      // 캐시 데이터 낙관적 업데이트
      queryClient.setQueryData<Todo[]>(QUERY_KEYS.todo.list, (old) => {
        if (!old) return [];
        return old.map((todo) =>
          todo.id === updateTodo.id ? { ...todo, ...updateTodo } : todo
        );
      });

      // context 객체로 반환하여 onError에서 사용 가능하게 함
      return { prevTodos };
    },

    // [예외 2 대응] 요청 실패 시 저장해둔 이전 데이터로 롤백
    onError: (error, variable, context) => {
      if (context?.prevTodos) {
        queryClient.setQueryData<Todo[]>(
          QUERY_KEYS.todo.list,
          context.prevTodos
        );
      }
      console.error('업데이트 실패:', error);
    },

    // [예외 3 대응] 성공/실패 여부와 관계없이 서버 데이터와 무결성 검사(리패칭)
    onSettled: () => {
      queryClient.invalidateQueries({
        queryKey: QUERY_KEYS.todo.list,
      });
    },
  });
}
```
